# Complete Architecture Diagram with IoT Message Flow

## 1. System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         QUEUE MANAGEMENT SYSTEM                              â”‚
â”‚                    Real-time Clinic Queue Management                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   KIOSK DEVICES      â”‚    â”‚   FRONTEND CLIENTS   â”‚    â”‚   ADMIN DASHBOARD    â”‚
â”‚  (Token Creators)    â”‚    â”‚   (Patient UI)       â”‚    â”‚   (Queue Manager)    â”‚
â”‚                      â”‚    â”‚                      â”‚    â”‚                      â”‚
â”‚  â€¢ Display Tokens    â”‚    â”‚  â€¢ Request Tokens    â”‚    â”‚  â€¢ Serve Patients    â”‚
â”‚  â€¢ Publish Status    â”‚    â”‚  â€¢ Track Wait Time   â”‚    â”‚  â€¢ Skip/Cancel       â”‚
â”‚  â€¢ IoT Connected     â”‚    â”‚  â€¢ Socket.IO Receive â”‚    â”‚  â€¢ View Queue        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                            â†“                           â†“
         â”‚                            â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                              â”‚
                    Socket.IO (WebSocket)               HTTP/Socket.IO
                          â”‚                              â”‚
                          â†“                              â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          EXPRESS SERVER (Node.js)                      â”‚
         â”‚          Port: 3000                                    â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
         â”‚  â”‚  â€¢ Kiosk Socket Handlers                         â”‚ â”‚
         â”‚  â”‚  â€¢ Token Creation & Management                   â”‚ â”‚
         â”‚  â”‚  â€¢ Queue State Management                        â”‚ â”‚
         â”‚  â”‚  â€¢ Real-time Broadcasting (Socket.IO)            â”‚ â”‚
         â”‚  â”‚  â€¢ MQTT Bridge (IoT Core Integration)            â”‚ â”‚
         â”‚  â”‚  â€¢ DynamoDB Sync                                 â”‚ â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“                        â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   LOCAL STORAGE    â”‚   â”‚   AWS DYNAMODB     â”‚
         â”‚   (queue.json)     â”‚   â”‚   (QueueEntries)   â”‚
         â”‚                    â”‚   â”‚                    â”‚
         â”‚  â€¢ Backup data     â”‚   â”‚  â€¢ Persistent      â”‚
         â”‚  â€¢ Quick access    â”‚   â”‚  â€¢ Multi-instance  â”‚
         â”‚  â€¢ Development     â”‚   â”‚  â€¢ Scalable        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â†‘
                                     DynamoDB Sync
                                    (UpdateCommand)

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           AWS IOT CORE (MQTT Broker)               â”‚
         â”‚  Endpoint: your-endpoint.iot.us-east-1.amazonaws   â”‚
         â”‚                                                     â”‚
         â”‚  Topics:                                            â”‚
         â”‚  â€¢ queue/clinic/default/updates (Server publishes) â”‚
         â”‚  â€¢ queue/clinic/default/incoming/+ (Devices pub)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†‘
                    MQTT (mTLS - Mutual TLS)
                         (Port 8883)
                                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                             â”‚
         â†“                                             â†“
    KIOSK DEVICE                              EXTERNAL SYSTEM
    (Python/JS)                               (Mobile App, etc.)
    - Subscribe: updates                      - Subscribe: updates
    - Publish: incoming/kiosk-1               - Publish: incoming/device-n
```

---

## 2. Token Generation Flow (Step-by-Step)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PATIENT TAKES TOKEN (User Story)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER BROWSER                          SERVER                        KIOSK SIM
  â”‚                                     â”‚                             â”‚
  â”œâ”€ Opens http://localhost:3000        â”‚                             â”‚
  â”‚  (React UI loads)                   â”‚                             â”‚
  â”‚                                     â”‚                             â”‚
  â”œâ”€ Sets name: "John Doe"              â”‚                             â”‚
  â”‚  (Saved in localStorage)            â”‚                             â”‚
  â”‚                                     â”‚                             â”‚
  â”œâ”€ Clicks "Take Token"                â”‚                             â”‚
  â”‚  (Emits Socket.IO event)            â”‚                             â”‚
  â”‚                                     â”‚                             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€ request_token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚                             â”‚
  â”‚  payload: {                         â”‚                             â”‚
  â”‚    name: "John Doe",                â”‚                             â”‚
  â”‚    phone: null                      â”‚                             â”‚
  â”‚  }                                  â”‚                             â”‚
  â”‚                                     â”œâ”€ Finds kiosk socket        â”‚
  â”‚                                     â”‚                             â”‚
  â”‚                                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€ request_token â”€â”€â”€â”€â†’ â”‚
  â”‚                                     â”‚  payload: {                â”‚
  â”‚                                     â”‚    requestId: "...",       â”‚
  â”‚                                     â”‚    profile: { ... }        â”‚
  â”‚                                     â”‚  }                         â”‚
  â”‚                                     â”‚                             â”‚
  â”‚                                     â”‚  â† kiosk_create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                     â”‚  payload: {                â”‚
  â”‚                                     â”‚    requestId: "...",       â”‚
  â”‚                                     â”‚    profile: { ... }        â”‚
  â”‚                                     â”‚  }                         â”‚
  â”‚                                     â”‚                             â”‚
  â”‚                                     â”œâ”€ Create token #5:          â”‚
  â”‚                                     â”‚  â€¢ status: "waiting"       â”‚
  â”‚                                     â”‚  â€¢ timestamp: now()        â”‚
  â”‚                                     â”‚  â€¢ name: "John Doe"        â”‚
  â”‚                                     â”‚  â€¢ waitingTime: 0          â”‚
  â”‚                                     â”‚                             â”‚
  â”‚                                     â”œâ”€ Save to queue.json        â”‚
  â”‚                                     â”‚                             â”‚
  â”‚                                     â”œâ”€ Sync to DynamoDB          â”‚
  â”‚                                     â”‚  (UpdateCommand)           â”‚
  â”‚                                     â”‚                             â”‚
  â”‚                                     â”œâ”€ Broadcast queue_update    â”‚
  â”‚                                     â”‚  (all clients)             â”‚
  â”‚                                     â”‚                             â”‚
  â”‚ â† token_issued â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
  â”‚  payload: { token: 5 }              â”‚                             â”‚
  â”‚                                     â”œâ”€ Publish to MQTT           â”‚
  â”‚                                     â”‚  Topic: queue/clinic/.../  â”‚
  â”‚                                     â”‚  Payload: { entries: [...] â”‚
  â”‚                                     â”‚             lastToken: 5 } â”‚
  â”‚                                     â”‚                             â”‚
  â”‚                                     â”œâ”€â”€â”€â”€â”€â”€â†’ AWS IoT Core        â”‚
  â”‚                                     â”‚                             â”‚
  â”‚ â† queue_update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
  â”‚  payload: {                         â”‚                             â”‚
  â”‚    lastToken: 5,                    â”‚                             â”‚
  â”‚    entries: [                       â”‚                             â”‚
  â”‚      {                              â”‚                             â”‚
  â”‚        token: 5,                    â”‚                             â”‚
  â”‚        name: "John Doe",            â”‚                             â”‚
  â”‚        status: "waiting",           â”‚                             â”‚
  â”‚        waitingTimeHuman: "0s"       â”‚                             â”‚
  â”‚      }                              â”‚                             â”‚
  â”‚    ]                                â”‚                             â”‚
  â”‚  }                                  â”‚                             â”‚
  â”‚                                     â”‚                             â”‚
  â”œâ”€ Shows "Token #5"                   â”‚                             â”‚
  â”‚ in UI + starts stopwatch            â”‚                             â”‚
  â”‚                                     â”‚                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIME PASSES... User waits at clinic...

USER BROWSER                          SERVER                      DYNAMODB
  â”‚                                     â”‚                            â”‚
  â”œâ”€ Stopwatch: 1s, 2s, 3s...          â”‚                            â”‚
  â”‚ (elapsedTime increments)            â”‚                            â”‚
  â”‚                                     â”‚                            â”‚
  â”œâ”€ Every 2 seconds:                  â”‚                            â”‚
  â”‚  emit("update_elapsed_time", {     â”‚                            â”‚
  â”‚    token: 5,                        â”‚                            â”‚
  â”‚    elapsedTime: 45                 â”‚                            â”‚
  â”‚  })                                â”‚                            â”‚
  â”‚                                     â”‚                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€ update_elapsed_time â”€â”€â”€â”€â”€â”€â†’ â”‚                            â”‚
  â”‚                                     â”œâ”€ Update entry.waitingTime â”‚
  â”‚                                     â”‚  to 45 seconds            â”‚
  â”‚                                     â”‚                            â”‚
  â”‚                                     â”œâ”€ Save to queue.json        â”‚
  â”‚                                     â”‚                            â”‚
  â”‚                                     â”œâ”€ Sync to DynamoDB â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                                     â”‚  UpdateCommand:            â”‚
  â”‚                                     â”‚  SET waitingTime = 45      â”‚
  â”‚                                     â”‚                            â”‚
  â”‚                                     â”œâ”€ Publish to MQTT           â”‚
  â”‚                                     â”‚  (new waitingTime: 45s)    â”‚
  â”‚                                     â”‚                            â”‚
  â”‚                                     â”œâ”€ Broadcast to all clients  â”‚
  â”‚                                     â”‚                            â”‚
  â”‚ â† queue_update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚  (new waitingTime: 45s)            â”‚                            â”‚
  â”‚                                     â”‚                            â”‚
  â”œâ”€ Display updates: "45s"             â”‚                            â”‚
  â”‚                                     â”‚                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. MQTT Message Flow (IoT Integration)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MQTT MESSAGE FLOW (AWS IoT Core)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SCENARIO: Kiosk Device publishes a message via MQTT

KIOSK DEVICE (Python)                AWS IOT CORE                    SERVER
  â”‚                                      â”‚                             â”‚
  â”œâ”€ Connect with mTLS                  â”‚                             â”‚
  â”‚  cert: spider.cert.pem              â”‚                             â”‚
  â”‚  key: spider.private.key            â”‚                             â”‚
  â”‚  endpoint: your-endpoint            â”‚                             â”‚
  â”‚                                      â”‚                             â”‚
  â”œâ”€ Publish MQTT Message              â”‚                             â”‚
  â”‚  Topic: queue/clinic/default/       â”‚                             â”‚
  â”‚          incoming/kiosk-1           â”‚                             â”‚
  â”‚                                      â”‚                             â”‚
  â”‚  Payload: {                         â”‚                             â”‚
  â”‚    "deviceId": "kiosk-1",           â”‚                             â”‚
  â”‚    "action": "token_displayed",     â”‚                             â”‚
  â”‚    "token": 5,                      â”‚                             â”‚
  â”‚    "timestamp": "2025-10-18..."     â”‚                             â”‚
  â”‚  }                                   â”‚                             â”‚
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”œâ”€ Message received          â”‚
  â”‚                                      â”‚ (QoS 1: At least once)    â”‚
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
  â”‚                                      â”‚  (Server subscribed to     â”‚
  â”‚                                      â”‚   queue/clinic/.../+)      â”‚
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚                             â”œâ”€ Parse JSON
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚                             â”œâ”€ Log message
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚                             â”œâ”€ Emit to UI
  â”‚                                      â”‚                             â”‚  via Socket.IO
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚                             â”œâ”€ All connected
  â”‚                                      â”‚                             â”‚  browsers receive
  â”‚                                      â”‚                             â”‚  socket event:
  â”‚                                      â”‚                             â”‚  "mqtt_message"
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚  â† Message ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                      â”‚  (QoS 1 acknowledgment)   â”‚
  â”‚                                      â”‚                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SCENARIO: Server publishes queue update to MQTT (broadcast to all devices)

SERVER                                AWS IOT CORE                 EXTERNAL DEVICES
  â”‚                                      â”‚                             â”‚
  â”œâ”€ broadcastQueue() called            â”‚                             â”‚
  â”‚  (token created/arrived/cancelled)  â”‚                             â”‚
  â”‚                                      â”‚                             â”‚
  â”œâ”€ Publish MQTT Message              â”‚                             â”‚
  â”‚  Topic: queue/clinic/default/       â”‚                             â”‚
  â”‚          updates                    â”‚                             â”‚
  â”‚                                      â”‚                             â”‚
  â”‚  Payload: {                         â”‚                             â”‚
  â”‚    "lastToken": 5,                  â”‚                             â”‚
  â”‚    "avgServiceSeconds": 180,        â”‚                             â”‚
  â”‚    "entries": [                     â”‚                             â”‚
  â”‚      {                              â”‚                             â”‚
  â”‚        "token": 5,                  â”‚                             â”‚
  â”‚        "name": "John Doe",          â”‚                             â”‚
  â”‚        "status": "waiting",         â”‚                             â”‚
  â”‚        "waitingTime": 45,           â”‚                             â”‚
  â”‚        "waitingTimeHuman": "45s"    â”‚                             â”‚
  â”‚      }                              â”‚                             â”‚
  â”‚    ]                                â”‚                             â”‚
  â”‚  }                                   â”‚                             â”‚
  â”‚                                      â”‚                             â”‚
  â”‚  QoS: 1 (At least once delivery)   â”‚                             â”‚
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”œâ”€ Broadcast to all          â”‚
  â”‚                                      â”‚  subscribed devices        â”‚
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
  â”‚                                      â”‚  (All devices subscribed   â”‚
  â”‚                                      â”‚   to queue/.../updates)    â”‚
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚                             â”œâ”€ Receive update
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚                             â”œâ”€ Parse queue state
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚                             â”œâ”€ Update screen:
  â”‚                                      â”‚                             â”‚  "Next: Token #5"
  â”‚                                      â”‚                             â”‚  "Wait: 45s"
  â”‚                                      â”‚                             â”‚
  â”‚                                      â”‚  â† ACK from devices â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                      â”‚                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Data Flow Through All Systems

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPLETE DATA FLOW (All Systems)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER ACTION: Patient arrives at clinic

BROWSER                 SERVER              LOCAL STORAGE          DYNAMODB
  â”‚                       â”‚                      â”‚                    â”‚
  â”œâ”€ Load UI               â”‚                      â”‚                    â”‚
  â”‚  http://localhost:     â”‚                      â”‚                    â”‚
  â”‚  3000                  â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ Connect Socket.IO     â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Accept connection   â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ broadcastQueue()    â”‚                    â”‚
  â”‚                        â”‚  (initial state)     â”‚                    â”‚
  â”‚                        â”‚                      â”œâ”€ Read queue.json   â”‚
  â”‚                        â”‚                      â”‚  (all entries)    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚ â† queue_update â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                    â”‚
  â”‚  (current state)       â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ Display queue         â”‚                      â”‚                    â”‚
  â”‚  (all waiting tokens)  â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ Set name: "John"      â”‚                      â”‚                    â”‚
  â”‚  (localStorage)        â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ Take Token button     â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ Kiosk creates token   â”‚                      â”‚                    â”‚
  â”‚  #5                    â”‚                      â”‚                    â”‚
  â”‚  (via simulator or     â”‚                      â”‚                    â”‚
  â”‚   real device)         â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Create entry:       â”‚                    â”‚
  â”‚                        â”‚  token: 5            â”‚                    â”‚
  â”‚                        â”‚  name: "John"        â”‚                    â”‚
  â”‚                        â”‚  status: "waiting"   â”‚                    â”‚
  â”‚                        â”‚  waitingTime: 0      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Write to file â”€â”€â”€â”€â”€â†’â”‚                    â”‚
  â”‚                        â”‚  queue.json          â”‚                    â”‚
  â”‚                        â”‚  (updated)           â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Sync to DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
  â”‚                        â”‚  PutCommand:         â”‚                    â”‚
  â”‚                        â”‚  INSERT entry into   â”‚                    â”‚
  â”‚                        â”‚  QueueEntries table  â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ broadcastQueue()    â”‚                    â”‚
  â”‚                        â”‚  (notify all)        â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚ â† queue_update â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                    â”‚
  â”‚ â† token_issued â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                    â”‚
  â”‚  token: 5              â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ Show "Token #5"       â”‚                      â”‚                    â”‚
  â”œâ”€ Start stopwatch       â”‚                      â”‚                    â”‚
  â”‚  (1s, 2s, 3s...)      â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ Every 2 seconds:      â”‚                      â”‚                    â”‚
  â”‚  emit                  â”‚                      â”‚                    â”‚
  â”‚  update_elapsed_time   â”‚                      â”‚                    â”‚
  â”‚  (elapsedTime: 45)     â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Update entry â”€â”€â”€â”€â”€â”€â†’â”‚ queue.json updatedâ”‚
  â”‚                        â”‚  waitingTime: 45     â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Sync to DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
  â”‚                        â”‚  UpdateCommand:      â”‚                    â”‚
  â”‚                        â”‚  SET waitingTime=45  â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Publish to MQTT â”€â†’ AWS IoT Core â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚                        â”‚  (all subscribers)   â”‚                  â”‚ â”‚
  â”‚                        â”‚                      â”‚                  â”‚ â”‚
  â”‚                        â”œâ”€ broadcastQueue()    â”‚                  â”‚ â”‚
  â”‚                        â”‚  (all browsers)      â”‚                  â”‚ â”‚
  â”‚                        â”‚                      â”‚                  â”‚ â”‚
  â”‚ â† queue_update â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                  â”‚ â”‚
  â”‚  (waitingTime: 45s)    â”‚                      â”‚                  â”‚ â”‚
  â”‚                        â”‚                      â”‚                  â”‚ â”‚
  â”œâ”€ Update display       â”‚                      â”‚                  â”‚ â”‚
  â”‚  "45s" on screen      â”‚                      â”‚                  â”‚ â”‚
  â”‚                        â”‚                      â”‚                  â”‚ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                                        â”‚
                                                         External Devices
                                                         receive update via MQTT

TIME PASSES: Patient arrives at window

BROWSER                 SERVER              LOCAL STORAGE          DYNAMODB
  â”‚                       â”‚                      â”‚                    â”‚
  â”œâ”€ Click "Arrived"       â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ POST /api/arrive      â”‚                      â”‚                    â”‚
  â”‚  { token: 5,          â”‚                      â”‚                    â”‚
  â”‚    elapsedTime: 324 }  â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Update entry:       â”‚                    â”‚
  â”‚                        â”‚  status: "arrived"   â”‚                    â”‚
  â”‚                        â”‚  arrivedAt: now()    â”‚                    â”‚
  â”‚                        â”‚  waitingTime: 324    â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Save to file â”€â”€â”€â”€â”€â†’â”‚ queue.json update  â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ Sync to DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
  â”‚                        â”‚  UpdateCommand:      â”‚                    â”‚
  â”‚                        â”‚  status="arrived"    â”‚                    â”‚
  â”‚                        â”‚  waitingTime=324     â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚                        â”œâ”€ broadcastQueue()    â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”‚ â† queue_update â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                    â”‚
  â”‚  (status: arrived)     â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â”œâ”€ Alert: "Arrived!"    â”‚                      â”‚                    â”‚
  â”‚  "Waited: 324s        â”‚                      â”‚                    â”‚
  â”‚   (5 minutes 24s)"    â”‚                      â”‚                    â”‚
  â”‚                        â”‚                      â”‚                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RESULT:
âœ… Queue updated in real-time
âœ… Waiting time accurately tracked (from browser stopwatch)
âœ… Data persisted to DynamoDB
âœ… All dashboards notified via Socket.IO
âœ… MQTT devices receive update
```

---

## 5. Architecture Components (Detailed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ARCHITECTURE COMPONENTS                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. FRONTEND (React via CDN)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ public/app.jsx (React Component)            â”‚
   â”‚                                             â”‚
   â”‚ State:                                      â”‚
   â”‚ â€¢ myToken: current patient's token         â”‚
   â”‚ â€¢ elapsedTime: stopwatch counter (1s tick) â”‚
   â”‚ â€¢ savedElapsedTime: final wait time        â”‚
   â”‚ â€¢ data: queue state from server            â”‚
   â”‚ â€¢ profile: name, phone (localStorage)      â”‚
   â”‚                                             â”‚
   â”‚ Functions:                                  â”‚
   â”‚ â€¢ takeToken(): emit request_token          â”‚
   â”‚ â€¢ markArrived(): POST /api/arrive          â”‚
   â”‚ â€¢ formatDuration(): "45s" display          â”‚
   â”‚                                             â”‚
   â”‚ Socket.IO Listeners:                        â”‚
   â”‚ â€¢ queue_update: full queue state           â”‚
   â”‚ â€¢ token_issued: your token created         â”‚
   â”‚ â€¢ mqtt_message: device messages            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. BACKEND SERVER (Express + Socket.IO)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ server.js (Node.js)                         â”‚
   â”‚                                             â”‚
   â”‚ Main Functions:                             â”‚
   â”‚ â€¢ broadcastQueue(): emit to all clients    â”‚
   â”‚ â€¢ syncToDynamo(): persist to AWS DB        â”‚
   â”‚ â€¢ initializeMQTT(): connect to IoT Core    â”‚
   â”‚ â€¢ createTokenEntry(): new token logic      â”‚
   â”‚                                             â”‚
   â”‚ Socket.IO Handlers:                         â”‚
   â”‚ â€¢ request_token: forward to kiosk          â”‚
   â”‚ â€¢ kiosk_create: create token from kiosk    â”‚
   â”‚ â€¢ update_elapsed_time: receive time sync   â”‚
   â”‚ â€¢ register: kiosk identification           â”‚
   â”‚                                             â”‚
   â”‚ HTTP Endpoints:                             â”‚
   â”‚ â€¢ POST /api/take: create token (admin)    â”‚
   â”‚ â€¢ POST /api/arrive: mark arrived          â”‚
   â”‚ â€¢ POST /api/cancel: cancel token          â”‚
   â”‚ â€¢ GET /api/queue: get queue state         â”‚
   â”‚                                             â”‚
   â”‚ MQTT Integration:                           â”‚
   â”‚ â€¢ Subscribe: incoming device messages     â”‚
   â”‚ â€¢ Publish: broadcast queue updates        â”‚
   â”‚ â€¢ Bridge: MQTT â†’ Socket.IO                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. DATA STORAGE LAYERS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Local Storage (queue.json)                   â”‚
   â”‚ â€¢ Fast access for server                    â”‚
   â”‚ â€¢ Backup if DB fails                        â”‚
   â”‚ â€¢ Development/testing                       â”‚
   â”‚                                             â”‚
   â”‚ Structure:                                   â”‚
   â”‚ {                                            â”‚
   â”‚   "lastToken": 5,                           â”‚
   â”‚   "entries": [                              â”‚
   â”‚     {                                        â”‚
   â”‚       "token": 5,                           â”‚
   â”‚       "name": "John Doe",                   â”‚
   â”‚       "status": "waiting",                  â”‚
   â”‚       "timestamp": "2025-10-18T...",        â”‚
   â”‚       "waitingTime": 324,                   â”‚
   â”‚       "clinicId": "default-clinic"          â”‚
   â”‚     }                                        â”‚
   â”‚   ]                                          â”‚
   â”‚ }                                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ AWS DynamoDB (QueueEntries Table)           â”‚
   â”‚ â€¢ Persistent across restarts               â”‚
   â”‚ â€¢ Multi-instance scalability                â”‚
   â”‚ â€¢ Audit trail / compliance                  â”‚
   â”‚                                             â”‚
   â”‚ Keys:                                        â”‚
   â”‚ â€¢ Partition: clinicId                       â”‚
   â”‚ â€¢ Sort: tokenId                             â”‚
   â”‚                                             â”‚
   â”‚ Attributes:                                  â”‚
   â”‚ â€¢ status, timestamp, personName             â”‚
   â”‚ â€¢ phoneNumber, waitingTime                  â”‚
   â”‚ â€¢ arrivedAt, servedAt, cancelledAt          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. AWS IOT CORE (MQTT Broker)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Topics:                                      â”‚
   â”‚                                             â”‚
   â”‚ queue/clinic/default/updates                â”‚
   â”‚ â†³ Server publishes queue state             â”‚
   â”‚ â†³ All devices subscribe                    â”‚
   â”‚ â†³ Payload: { entries: [...] }              â”‚
   â”‚                                             â”‚
   â”‚ queue/clinic/default/incoming/+             â”‚
   â”‚ â†³ Devices publish status updates           â”‚
   â”‚ â†³ Server subscribes and relays             â”‚
   â”‚ â†³ Payload: { deviceId, action, ... }       â”‚
   â”‚                                             â”‚
   â”‚ Protocol: MQTTS (TLS 1.2)                   â”‚
   â”‚ Port: 8883                                  â”‚
   â”‚ Auth: mTLS with device certificates         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. COMMUNICATION PROTOCOLS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Socket.IO (Browser â†” Server)               â”‚
   â”‚ â€¢ Real-time bidirectional messaging        â”‚
   â”‚ â€¢ WebSocket + fallback polling             â”‚
   â”‚ â€¢ Low latency (~50-100ms)                   â”‚
   â”‚ â€¢ Suitable for all modern browsers         â”‚
   â”‚                                             â”‚
   â”‚ MQTT (Server â†” IoT Core â†” Devices)         â”‚
   â”‚ â€¢ Publish-Subscribe messaging              â”‚
   â”‚ â€¢ QoS 1: At-least-once delivery            â”‚
   â”‚ â€¢ Persistent connections                   â”‚
   â”‚ â€¢ Low bandwidth, efficient                  â”‚
   â”‚                                             â”‚
   â”‚ HTTP (Admin actions)                        â”‚
   â”‚ â€¢ REST endpoints for server actions        â”‚
   â”‚ â€¢ POST /api/arrive, /api/cancel            â”‚
   â”‚ â€¢ Synchronous operations                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Timeline: From Token Creation to Arrival

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPLETE TIMELINE: Patient Journey                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T=0s    Patient enters clinic
        â”œâ”€ Opens http://localhost:3000
        â”œâ”€ Enters name: "John Doe"
        â””â”€ Clicks "Take Token"

T=0s+   Browser sends: request_token
        â”œâ”€ Server finds kiosk simulator
        â””â”€ Kiosk receives request

T=0.5s  Kiosk creates token #5
        â”œâ”€ Entry saved to queue.json
        â”œâ”€ Entry synced to DynamoDB
        â”œâ”€ Server broadcasts queue_update
        â””â”€ Emits token_issued to browser

T=1s    Browser receives token_issued
        â”œâ”€ UI shows "Token #5"
        â”œâ”€ Stopwatch starts: 1s
        â””â”€ Saves tokenStartTime

T=2s    Stopwatch: 2s
        â””â”€ (no action, just counting)

T=4s    Stopwatch: 4s
        â”œâ”€ Browser emits update_elapsed_time (4)
        â””â”€ Server updates entry.waitingTime = 4

T=6s    Stopwatch: 6s
        â”œâ”€ Server broadcasts queue_update
        â”œâ”€ Publishes to MQTT: queue/.../updates
        â”œâ”€ All dashboards refresh
        â””â”€ Devices receive MQTT message

T=10s   Stopwatch: 10s
        â””â”€ (continues counting)

T=12s   Stopwatch: 12s
        â”œâ”€ Browser emits update_elapsed_time (12)
        â””â”€ Server syncs to DynamoDB

T=300s  Stopwatch: 300s (5 minutes)
        â”œâ”€ Patient approaches window
        â”œâ”€ Patient's position changes in queue
        â””â”€ Other admins see real-time position

T=324s  Patient arrives at window
        â”œâ”€ Clicks "Marked Arrived"
        â”œâ”€ POST /api/arrive { token: 5, elapsedTime: 324 }
        â”œâ”€ Server updates status: "arrived"
        â”œâ”€ Saves final waitingTime: 324 (5m 24s)
        â”œâ”€ Syncs to DynamoDB
        â”œâ”€ Broadcasts to all dashboards
        â”œâ”€ Publishes to MQTT devices
        â”œâ”€ Alert: "Time waited: 5m 24s"
        â””â”€ Token removed from queue display

T=324s+ Patient is served (admin marks served)
        â”œâ”€ Status changes to "served"
        â”œâ”€ Queue refreshes
        â””â”€ Next patient info displays

RESULT STORED IN DYNAMODB:
{
  "clinicId": "default-clinic",
  "tokenId": "5",
  "token": 5,
  "personName": "John Doe",
  "status": "served",
  "timestamp": "2025-10-18T10:30:00Z",
  "arrivedAt": "2025-10-18T10:35:24Z",
  "servedAt": "2025-10-18T10:35:45Z",
  "waitingTime": 324,
  "waitingTimeHuman": "5m 24s"
}
```

---

## 7. Key Features Explained

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           KEY FEATURES BREAKDOWN                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. REAL-TIME STOPWATCH â±ï¸
   How it works:
   â”œâ”€ Frontend: window.setInterval() every 1000ms
   â”œâ”€ Increments elapsedTime state
   â”œâ”€ Displays to patient in real-time
   â”œâ”€ Sends to server every 2 seconds
   â”œâ”€ Server persists to DynamoDB
   â””â”€ All other dashboards update

   Why it's accurate:
   â””â”€ Browser controls the time (not network dependent)
   â””â”€ Server acts as backup storage only
   â””â”€ No drift between what patient sees and what's saved

2. KIOSK-ONLY TOKEN GENERATION ğŸŸï¸
   How it works:
   â”œâ”€ Web UI sends request_token via Socket.IO
   â”œâ”€ Server checks: Is a kiosk connected?
   â”œâ”€ If YES: Forward request to kiosk
   â”œâ”€ If NO: Reject with "no_kiosk_connected"
   â””â”€ Only kiosk can create tokens

   Why this matters:
   â”œâ”€ Controlled token distribution
   â”œâ”€ Physical kiosk validates queue discipline
   â”œâ”€ Prevents spam/duplicate requests
   â””â”€ Ensures fair queue management

3. MQTT BRIDGE FOR IOT DEVICES ğŸŒ
   How it works:
   â”œâ”€ Server connects to AWS IoT Core (mTLS)
   â”œâ”€ Subscribes to: queue/clinic/default/incoming/+
   â”œâ”€ Devices publish their status
   â”œâ”€ Server receives MQTT message
   â”œâ”€ Converts to Socket.IO event
   â”œâ”€ All browsers get the update
   â””â”€ Server also publishes queue updates to MQTT

   Why it's useful:
   â”œâ”€ Multiple kiosks stay in sync
   â”œâ”€ Mobile apps can subscribe to MQTT too
   â”œâ”€ Scale to many devices without server load
   â””â”€ Decoupled from web clients

4. DYNAMODB PERSISTENCE ğŸ’¾
   How it works:
   â”œâ”€ Every token change â†’ UpdateCommand to DB
   â”œâ”€ Server loads queue on startup
   â”œâ”€ Acts as source of truth
   â”œâ”€ Multiple server instances share same DB
   â””â”€ Historical data for analytics

   Why it matters:
   â”œâ”€ Data survives server restarts
   â”œâ”€ Compliance/audit trail
   â”œâ”€ Scalable to thousands of patients
   â”œâ”€ Can run multiple servers (HA/LB)
   â””â”€ Analytics on wait times

5. MULTI-CLIENT SYNCHRONIZATION ğŸ“¡
   How it works:
   â”œâ”€ Socket.IO connects each browser
   â”œâ”€ Server broadcasts queue_update to all
   â”œâ”€ Every change triggers broadcast
   â”œâ”€ All dashboards refresh simultaneously
   â””â”€ Admin sees real-time queue state

   Why it's important:
   â”œâ”€ Admins see accurate queue position
   â”œâ”€ Multiple screens stay in sync
   â”œâ”€ Prevents double-serving
   â””â”€ Real-time decision making
```

---

## 8. Request/Response Examples

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REAL EXAMPLE REQUESTS/RESPONSES                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

REQUEST 1: Browser asks for token
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Browser emits:
socket.emit("request_token", {
  name: "John Doe",
  phoneNumber: "555-1234"
})

Server receives and forwards to kiosk:
socket_kiosk.emit("request_token", {
  requestId: "1729254600000-123",
  profile: {
    name: "John Doe",
    phoneNumber: "555-1234"
  }
})

Kiosk responds:
socket.emit("kiosk_create", {
  requestId: "1729254600000-123",
  profile: { name: "John Doe", ... }
})

Server broadcasts to all browsers:
io.emit("queue_update", {
  lastToken: 5,
  avgServiceSeconds: 180,
  entries: [
    {
      token: 5,
      tokenId: "5",
      name: "John Doe",
      status: "waiting",
      timestamp: "2025-10-18T10:30:00Z",
      waitingTime: 0,
      waitingTimeHuman: "0s"
    }
  ]
})

Server also emits:
socket.emit("token_issued", { token: 5 })

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

REQUEST 2: Browser sends elapsed time (every 2 seconds)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Browser emits:
socket.emit("update_elapsed_time", {
  token: 5,
  elapsedTime: 45
})

Server updates DynamoDB:
UpdateCommand({
  TableName: "QueueEntries",
  Key: {
    clinicId: "default-clinic",
    tokenId: "5"
  },
  UpdateExpression: "SET waitingTime = :wt",
  ExpressionAttributeValues: {
    ":wt": "45"
  }
})

Server broadcasts:
io.emit("queue_update", {
  entries: [
    {
      token: 5,
      waitingTime: 45,
      waitingTimeHuman: "45s"
    }
  ]
})

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

REQUEST 3: Patient clicks "Marked Arrived"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Browser sends:
POST /api/arrive
Content-Type: application/json

{
  "token": 5,
  "elapsedTime": 324
}

Server response:
{
  "success": true,
  "waitingTime": 324
}

Server updates DynamoDB:
UpdateCommand({
  TableName: "QueueEntries",
  Key: {
    clinicId: "default-clinic",
    tokenId: "5"
  },
  UpdateExpression: "SET #s = :status, arrivedAt = :at, waitingTime = :wt",
  ExpressionAttributeNames: {
    "#s": "status"
  },
  ExpressionAttributeValues: {
    ":status": "arrived",
    ":at": "2025-10-18T10:35:24Z",
    ":wt": "324"
  }
})

Server broadcasts:
io.emit("queue_update", {
  entries: [
    {
      token: 5,
      status: "arrived",
      arrivedAt: "2025-10-18T10:35:24Z",
      waitingTime: 324,
      waitingTimeHuman: "5m 24s"
    }
  ]
})

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

REQUEST 4: MQTT Device publishes status
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Device publishes:
Topic: queue/clinic/default/incoming/kiosk-1
Payload:
{
  "deviceId": "kiosk-1",
  "action": "token_displayed",
  "token": 5,
  "timestamp": "2025-10-18T10:35:00Z"
}

Server receives and broadcasts to browsers:
io.emit("mqtt_message", {
  topic: "queue/clinic/default/incoming/kiosk-1",
  payload: {
    deviceId: "kiosk-1",
    action: "token_displayed",
    token: 5,
    timestamp: "2025-10-18T10:35:00Z"
  }
})

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

REQUEST 5: GET /api/queue (get current queue state)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Browser sends:
GET /api/queue

Server response:
{
  "lastToken": 5,
  "avgServiceSeconds": 180,
  "entries": [
    {
      "token": 1,
      "name": "Patient A",
      "status": "served",
      "waitingTime": 600,
      "waitingTimeHuman": "10m"
    },
    {
      "token": 5,
      "name": "John Doe",
      "status": "waiting",
      "waitingTime": 45,
      "waitingTimeHuman": "45s"
    },
    {
      "token": 6,
      "name": "Patient B",
      "status": "waiting",
      "waitingTime": 0,
      "waitingTimeHuman": "0s"
    }
  ]
}
```

---

## Summary

This architecture creates a **real-time, scalable clinic queue system** that:

1. âœ… Tracks patient wait times accurately (browser stopwatch)
2. âœ… Persists data to DynamoDB (never lost)
3. âœ… Syncs across all devices via Socket.IO (real-time dashboards)
4. âœ… Integrates with AWS IoT Core via MQTT (scalable device connectivity)
5. âœ… Requires kiosk for tokens (controlled distribution)
6. âœ… Works offline with local JSON fallback
7. âœ… Ready for production with HA/LB setup

The system is **modular, scalable, and production-ready**! ğŸš€
