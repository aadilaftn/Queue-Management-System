<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IoT Simulator</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <div style="display: flex; align-items: center; gap: 12px">
          <div class="title">Simulator</div>
          <div class="tag muted">Emit tokens for testing</div>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="card" style="max-width: 560px; margin: 16px auto">
        <h3 class="h1">IoT Device Simulator</h3>
        <p class="muted">Simulate a kiosk/device that issues tokens.</p>
        <div class="mb-2">
          <label>Number of tokens to emit</label>
          <input id="count" type="number" value="1" />
        </div>
        <div class="mb-2">
          <label>Interval (ms)</label>
          <input id="interval" type="number" value="500" />
        </div>
        <div class="actions">
          <button id="emit" class="btn btn-primary">Emit Tokens</button>
        </div>
        <div id="log" class="mt-2"></div>
      </div>
    </main>

    <div class="footer">Simulator Â· Clinic Queue System</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let registered = false;
      function logMsg(s) {
        const log = document.getElementById("log");
        const p = document.createElement("div");
        p.innerText = s;
        log.appendChild(p);
      }

      document.getElementById("emit").addEventListener("click", async () => {
        // legacy: direct API emit (will be blocked if server requires kiosk)
        const count = parseInt(
          document.getElementById("count").value || "1",
          10
        );
        const interval = parseInt(
          document.getElementById("interval").value || "500",
          10
        );
        for (let i = 0; i < count; i++) {
          if (!registered) {
            logMsg(
              "No kiosk registration: use Register button to register as kiosk"
            );
            break;
          }
          // wait for request_token from server (we will also accept request_token forwarded to us)
          logMsg("Ready to accept token requests from server");
          await new Promise((r) => setTimeout(r, interval));
        }
      });

      // register button to identify this client as a kiosk
      const regBtn = document.createElement("button");
      regBtn.className = "btn btn-primary";
      regBtn.innerText = "Register as kiosk";
      regBtn.addEventListener("click", () => {
        socket.emit("register", { role: "kiosk", clientId: "Kiosk-Sim" });
      });
      document.querySelector(".actions").appendChild(regBtn);

      socket.on("connect", () => {
        // auto-register on connect
        try {
          socket.emit("register", { role: "kiosk", clientId: "Kiosk-Sim" });
        } catch (e) {}
      });

      socket.on("registered", (d) => {
        registered = true;
        logMsg(
          "Registered as kiosk" +
            (d && d.clientId ? " (" + d.clientId + ")" : "")
        );
      });

      // when server forwards a request_token, create token by calling kiosk_create
      socket.on("request_token", (payload) => {
        logMsg("Received request_token: " + JSON.stringify(payload));
        // simulate kiosk creating token and notify server
        const profile = (payload && payload.profile) || {};
        // inform server that kiosk created a token (server will persist it)
        socket.emit("kiosk_create", { requestId: payload.requestId, profile });
      });

      socket.on("kiosk_create_ack", (d) => {
        logMsg("Server acknowledged kiosk_create: " + JSON.stringify(d));
      });
    </script>
  </body>
</html>
